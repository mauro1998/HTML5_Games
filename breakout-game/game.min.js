'use strict';

(function () {
  var state = { preload: preload, create: create, update: update };
  var game = new Phaser.Game(480, 320, Phaser.AUTO, null, state, false, true);
  var obj = {};
  var assets = [{ name: 'start', src: 'img/start.png' }, { name: 'ball', src: 'img/ball.png' }, { name: 'paddle', src: 'img/paddle.png' }, { name: 'brick', src: 'img/brick.png' }, { name: 'wobble', src: 'img/wobble.png' }];

  // Game variables:
  var score = 0;
  var lives = 3;

  function preload() {
    game.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;
    game.scale.pageAlignHorizontally = true;
    game.scale.pageAlignVertically = true;
    game.stage.backgroundColor = '#eee';

    assets.forEach(function (asset) {
      var name = asset.name,
          src = asset.src;

      game.load.image(name, src);
    });
  }

  function createBall() {
    var ball = game.add.sprite(game.world.centerX, 290, 'ball');
    ball._initialX = ball.x;
    ball._initialY = ball.y;
    game.physics.enable(ball, Phaser.Physics.ARCADE);
    ball.anchor.set(0.5);
    ball.body.velocity.set(200, -200);
    ball.body.collideWorldBounds = true;
    ball.body.collideWorldBoundBottom = false;
    ball.checkWorldBounds = true;
    ball.body.bounce.set(1);
    return ball;
  }

  function createPaddle() {
    var paddle = game.add.sprite(game.world.centerX, 305, 'paddle');
    paddle._initialX = paddle.x;
    paddle._initialY = paddle.y;
    paddle.anchor.set(0.5, 0);
    game.physics.enable(paddle, Phaser.Physics.ARCADE);
    paddle.body.immovable = true;
    return paddle;
  }

  function createBricks() {
    var bricks = game.add.group();
    var rows = 2;
    var columns = 2;
    var paddingX = 20;
    var paddingY = 10;

    for (var i = 0; i < rows; i++) {
      for (var j = 0; j < columns; j++) {
        var brick = game.add.sprite(0, 0, 'brick');
        var x = (brick.width + paddingX) * i;
        var y = (brick.height + paddingY) * j;
        brick.position.set(x, y);

        game.physics.enable(brick, Phaser.Physics.ARCADE);
        brick.body.immovable = true;
        bricks.add(brick);
      }
    }

    bricks.position.set(game.world.centerX, paddingY * 4);
    bricks.pivot.set(bricks.width / 2, 0);
    return bricks;
  }

  function createGameScoreText() {
    var scoreText = game.add.text(10, 10, 'Score: ' + score, {
      font: 'Arial',
      fontSize: 16
    });

    return scoreText;
  }

  function createLivesText() {
    var livesText = game.add.text(game.width - 10, 10, 'Lives: ' + lives, {
      font: 'Arial',
      fontSize: 16
    });

    livesText.anchor.set(1, 0);
    return livesText;
  }

  function createLifeLostText() {
    var _game$world = game.world,
        centerX = _game$world.centerX,
        centerY = _game$world.centerY;

    var txt = 'Live lost, click to continue';
    var livesText = game.add.text(centerX, centerY, txt, {
      font: 'Arial',
      fontSize: 16
    });

    livesText.anchor.set(0.5, 0.5);
    livesText.visible = false;
    return livesText;
  }

  function onBallHitsBrick(ball, brick) {
    score += 10;
    obj.score.setText('Score: ' + score);
    brick.kill();

    var allBricksKilled = obj.bricks.children.every(function (child) {
      return !child.alive;
    });

    if (allBricksKilled) {
      setTimeout(function () {
        alert('CONGRATULATIONS, YOU WON!\nYou have scored ' + score + ' points');
        location.reload();
      }, 300);
    }
  }

  function onBallOutOfBounds() {
    lives -= 1;

    if (lives) {
      obj.lives.setText('Lives: ' + lives);
      obj.lifeLost.visible = true;
      obj.ball.reset(obj.ball._initialX, obj.ball._initialY);
      obj.paddle.reset(obj.paddle._initialX, obj.paddle._initialY);
      game.input.onDown.addOnce(function () {
        obj.lifeLost.visible = false;
        obj.ball.body.velocity.set(200, -200);
      });
    } else {
      alert('GAME OVER\nYou scored ' + score + ' points.');
      location.reload();
    }
  }

  function create() {
    game.physics.startSystem(Phaser.Physics.ARCADE);
    game.physics.arcade.checkCollision.down = false;

    obj.ball = createBall();
    obj.paddle = createPaddle();
    obj.bricks = createBricks();
    obj.score = createGameScoreText();
    obj.lives = createLivesText();
    obj.lifeLost = createLifeLostText();

    obj.ball.events.onOutOfBounds.add(onBallOutOfBounds);
  }

  function update() {
    game.physics.arcade.collide(obj.ball, obj.paddle);
    game.physics.arcade.collide(obj.ball, obj.bricks, onBallHitsBrick);
    obj.paddle.x = game.input.x || obj.paddle._initialX;
  }
})();
